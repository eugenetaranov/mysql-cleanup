version: '3'

tasks:
  build:
    desc: Build the MySQL cleanup binary
    cmds:
      - cd .. && go build -o bin/mysql_cleanup
    sources:
      - ../main.go
      - ../go.mod
      - ../go.sum
    generates:
      - ../bin/mysql_cleanup

  up:
    desc: Start MySQL container with test databases
    cmds:
      - docker-compose up -d
    status:
      - docker-compose ps | grep -q "mysql.*Up"

  down:
    desc: Stop and remove MySQL container
    cmds:
      - docker-compose down

  restart:
    desc: Restart MySQL container
    cmds:
      - task: down
      - task: up

  logs:
    desc: Show container logs
    cmds:
      - docker-compose logs mysql -f

  status:
    desc: Show container status
    cmds:
      - docker-compose ps

  mysql:
    desc: Connect to MySQL CLI
    cmds:
      - docker-compose exec mysql mysql -u root -proot

  show-dbs:
    desc: Show available databases
    cmds:
      - docker-compose exec mysql mysql -u root -proot -e "SHOW DATABASES;"

  show-tables:
    desc: Show tables in acme_corp database
    cmds:
      - docker-compose exec mysql mysql -u root -proot acme_corp -e "SHOW TABLES;"

  reset:
    desc: Reset databases (remove and recreate)
    cmds:
      - task: down
      - docker-compose up -d --force-recreate

  clean:
    desc: Clean up everything including volumes
    cmds:
      - docker-compose down -v
      - docker-compose rm -f

  test:
    desc: Build, reset database, and test the application
    cmds:
      - task: build
      - task: reset
      - sleep 5
      - ../bin/mysql_cleanup -config config.yaml -host localhost -port 3306 -user test_user -password test_password -db acme_corp -table account_user
      - task: clean
